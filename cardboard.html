<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js" charset="utf-8"></script>

  <script src="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.min.js"></script>
  <link href="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.css" rel="stylesheet" type="text/css">

  <script src="/cardboard.js"></script>
  <link href="/cardboard.css" rel="stylesheet" type="text/css">
</head>

<body>

<header>
  <ul id="taglist" class="navbar-right">
  </ul>
</header>

<main class="container">

</main>

<script type="text/javascript">
  var queries=getQueries();
  var tagMap={};
  var dataMap={};
  var chartMap={};
  var counter=0;
  queries["data"].split(";").forEach(function(url){
    d3.json(url, function(error, datasets){
      datasets.forEach(function(dataset){
        var cls = dataset["class"];
        var fulltag = dataset["tag"];
        var shorttag;

        if (fulltag in tagMap){
          shorttag = tagMap[fulltag];
        } else { // give a unique identifier (A, B, C, ...) for each tag
          shorttag = String.fromCharCode(65 + counter);
          counter++;
          d3.select("#taglist").append("li").text(shorttag + " - " + fulltag);
          tagMap[fulltag] = shorttag;
        }

        if (cls in dataMap){ // extend a set of series
          dataMap[cls] = fromDataset(shorttag, dataset["series"], queries, dataMap[cls]);
        } else {
          var section = d3.select("main").append("section");
          section.classed("with-3d-shadow with-transitions");
          section.append("h2").text(cls);
          var svg = section.append("svg");

          dataMap[cls] = fromDataset(shorttag, dataset["series"], queries, []);

          addChart(svg, dataset, dataMap);
        }
      });
    });
  });
</script>
</body>
</html>
